<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Zip Boundaries - Clean (v2)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,body{height:100%;margin:0;}
      body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "DM Sans", sans-serif;}
      #map{height:100vh;width:100%;}
      #debug{position:fixed;left:10px;bottom:10px;z-index:10000;background:rgba(255,255,255,0.9);padding:8px;border-radius:6px;font-size:12px;max-width:320px;max-height:160px;overflow:auto;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="debug" aria-hidden="false">Debug console:<br/><small id="dbg"></small></div>

    <script>
      const dbg = (msg) => {
        console.log(msg);
        const el = document.getElementById('dbg');
        el.innerHTML += msg + '<br/>';
      };

      let lastHighlighted = null;
      function highlightFeature(map, feature){
        clearHighlight(map);
        lastHighlighted = feature;
        map.data.overrideStyle(feature, { strokeWeight: 3, zIndex: 1000 });
      }
      function clearHighlight(map){
        if (lastHighlighted){ map.data.revertStyle(lastHighlighted); lastHighlighted = null; }
      }

      function computeBoundsFromData(geojson){
        const bounds = new google.maps.LatLngBounds();
        const addCoords = (coords) => {
          coords.forEach(pt => {
            if (typeof pt[0] === 'number' && typeof pt[1] === 'number') {
              bounds.extend(new google.maps.LatLng(pt[1], pt[0]));
            } else {
              // nested array (rings/multipolygon)
              addCoords(pt);
            }
          });
        };

        if (geojson.type === 'FeatureCollection') {
          geojson.features.forEach(f => {
            if (!f.geometry) return;
            addCoords(f.geometry.coordinates);
          });
        } else if (geojson.type === 'Feature') {
          addCoords(geojson.geometry.coordinates);
        } else if (geojson.coordinates) {
          addCoords(geojson.coordinates);
        }
        return bounds;
      }

      function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 10,
          center: { lat: 39.9526, lng: -75.1652 },
          disableDefaultUI: true,
          zoomControl: true
        });

        map.data.setStyle(() => ({
          fillColor: 'transparent',
          fillOpacity: 0,
          strokeColor: '#444',
          strokeWeight: 1.2
        }));

        map.data.addListener('click', (e) => {
          highlightFeature(map, e.feature);
        });
        map.data.addListener('mouseover', (e) => {
          map.data.overrideStyle(e.feature, { strokeWeight: 2.6 });
        });
        map.data.addListener('mouseout', (e) => {
          if (lastHighlighted !== e.feature) map.data.revertStyle(e.feature);
        });

        // Try to load GeoJSON using fetch and handle common errors.
        dbg('Attempting to fetch zip-map.json (relative path).');
        fetch('zip-map.json')
          .then(resp => {
            if (!resp.ok) throw new Error('Network response was not ok: ' + resp.status + ' ' + resp.statusText);
            const ct = resp.headers.get('content-type') || '';
            dbg('Received: ' + resp.status + ' Content-Type: ' + ct);
            return resp.json();
          })
          .then(data => {
            dbg('Successfully fetched GeoJSON — adding to map.');
            map.data.addGeoJson(data);
            // Fit map to bounds of features (if any)
            try {
              const bounds = computeBoundsFromData(data);
              if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
                dbg('Fitted map to GeoJSON bounds.');
              } else {
                dbg('GeoJSON bounds were empty; using default center/zoom.');
              }
            } catch (err) {
              console.error(err);
              dbg('Error computing bounds: ' + err.message);
            }
          })
          .catch(err => {
            console.error('Failed to load zip-map.json', err);
            dbg('Error loading zip-map.json: ' + err.message + 
                '<br/><strong>Common causes:</strong> viewing the file via the GitHub file preview (github.com) will NOT render the page — use GitHub Pages or run a local web server. Also check CORS, file path, and API key restrictions.');
          });

        // Helpful note in console
        dbg('If map tiles/errors appear, open DevTools Console for detailed errors (API key, CORS, blocked by referrer, etc.).');
      }

      window.initMap = initMap;
    </script>

    <!--
      IMPORTANT NOTES:
      1) To preview this HTML from a GitHub repo, enable GitHub Pages for the branch (Settings -> Pages)
         or use a local server (e.g., `python -m http.server`) and open http://localhost:8000/.
      2) If your Google Maps API key is restricted by HTTP referrers, it must allow the domain used for testing
         (localhost, yourdomain.github.io, rawgit preview domain, etc.). Check the Cloud Console API restrictions.
      3) If the GeoJSON fails to load due to CORS, host zip-map.json on the same origin (GitHub Pages or same server).
    -->

    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDihHSv5KORtpnnMC7umGgXWBJm5NSduc8&callback=initMap">
    </script>
  </body>
</html>
