
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dankmates Delivery Zones</title>

    <!-- Google Fonts (free) -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@500;600&family=DM+Sans:wght@500;600&family=Anton&display=swap" rel="stylesheet">

    <style>
      /* If you own Futura Condensed Extra Bold, upload it to /fonts and keep this.
         Otherwise we fall back to Anton (already loaded), Impact, system sans. */
      @font-face{
        font-family: "FuturaCE-ExtraBoldCondensed";
        src: url("./fonts/FuturaCondensedExtraBold.woff2") format("woff2");
        font-weight: 800;
        font-style: normal;
        font-display: swap;
      }

      :root{
        --bg:#ffffff; --text:#111827; --muted:#6b7280;
        --ring:rgba(37,99,235,.25);
        --shadow:0 8px 24px rgba(0,0,0,.12); --radius:14px;

        /* Zone colors (your palette) */
        --free:#A2DD9B;         /* light green */
        --fee-6:#FFE770;        /* light yellow */
        --fee-6-pre:#FFDD31;    /* slightly darker yellow */
        --fee-10:#FFB43A;       /* medium yellow */
        --fee-10-pre:#FF9E20;   /* medium-dark yellow */
        --fee-15:#FC6722;       /* orange */
        --fee-15-pre:#FF5100;   /* darker orange */
        --fee-20:#ED0101;       /* red */
        --fee-20-pre:#D10000;   /* darker red */
      }

      html,body{height:100%;margin:0;}
      body{font-family: "DM Sans", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
      #map{height:100%;width:100%;}

      /* Search control (placed in TOP_LEFT by JS) */
      #searchWrap{
        display:flex; align-items:center; gap:8px;
        background:var(--bg); color:var(--text);
        border-radius:var(--radius); padding:10px 12px;
        box-shadow:var(--shadow); border:1px solid #e5e7eb;
        margin:10px;
      }
      #searchWrap .icon{width:18px;height:18px;fill:var(--muted);}
      #search{width:320px;max-width:62vw;border:none;outline:none;font-size:14px;color:var(--text);background:transparent;}
      #search::placeholder{color:#9ca3af;}
      #searchWrap:focus-within{box-shadow:var(--shadow),0 0 0 4px var(--ring);border-color:#d1d5db;}
      #clearBtn{appearance:none;border:none;background:#f3f4f6;color:#6b7280;width:26px;height:26px;border-radius:8px;cursor:pointer;line-height:26px;text-align:center;font-size:14px;}
      #clearBtn:hover{background:#e5e7eb;}
      
      /* Close button inside the zipcode popup — matches #clearBtn */
.dm-close{
  appearance:none; border:none; background:#f3f4f6; color:#6b7280;
  width:26px; height:26px; border-radius:8px; cursor:pointer;
  line-height:26px; text-align:center; font-size:14px;
}
.dm-close:hover{ background:#e5e7eb; }

/* a11y helper */
.sr-only{
  position:absolute; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}

      /* --- Popup styled like your screenshot --- */
      .dm-popup{
        font-family: "DM Sans", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color:#0b0b0c;
        min-width: 220px; max-width: 320px;
        background:#fff;
        border:none;
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,.14);
        overflow:hidden;
      }
      .dm-head{
        display:flex; justify-content:space-between; align-items:center;
        gap:12px; padding:12px 12px;
        background:#fff;
      }
      .dm-title{
        /* Futura Condensed Extra Bold → fallback to Anton if not present */
        font-family: "FuturaCE-ExtraBoldCondensed","Anton","Impact",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        font-weight: 800;
        letter-spacing: .3px;
        font-size: 22px;
        line-height: 1;
        text-transform: uppercase;
      }
      .dm-rowline{
        display:flex; justify-content:space-between; align-items:center;
        gap:12px; margin-top:10px;
      }
      .dm-pill{
        display:inline-flex; align-items:center; gap:8px;
        height: 28px; padding:0 12px; border-radius: 14px;
        border: 1px solid rgba(0,0,0,.10);
        background:#fff;
        font-size:14px; font-weight:600; letter-spacing:.1px;
      }
      .dm-prepay{
  display:inline-flex; align-items:center; justify-content:center;
  height:22px; padding:0 10px; border-radius:999px;
  border:1px solid #f5d565; background:#fff8e1; color:#8b5e00;
  font-size:12px; font-weight:700; line-height:1;  /* no extra vertical lead */
  margin-left:8px;
}
      .dm-zip{
        font-family: "DM Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        background:#111827; color:#fff; border-color:#111827;
      }
      .dm-body{padding:0 12px 12px 12px;}
      .dm-left{display:flex; align-items:center;}
      .dm-fee-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:8px;}
      
/* Remove Google InfoWindow chrome so only our custom .dm-close shows */
.gm-style .gm-ui-hover-effect{ display:none !important; }           /* the default "X" */
.gm-style .gm-style-iw-c{ padding:0 !important; background:transparent !important; box-shadow:none !important; border:none !important; }
.gm-style .gm-style-iw-d{ overflow:visible !important; }            /* allow our rounded corners/shadow to show cleanly */
.gm-style .gm-style-iw-tc,
.gm-style .gm-style-iw-tc::after{ display:none !important; }        /* hides the little pointer triangle */

      
    </style>

    <script>
/** GROUPS — label is the fee; prepay indicates prepayment zones */
const ZIP_GROUPS = [
  { label:"$6",        fee:6,  prepay:false, color:getColor("$6"),        zips:["19153","19131","19151","19140","19134","19129","19142"] },
  { label:"$6 Prepay", fee:6,  prepay:true,  color:getColor("$6 Prepay"), zips:["19032","19079","19023","19050"] },
  { label:"$10",       fee:10, prepay:false, color:getColor("$10"),       zips:["19144","19141","19120","19124","19137"] },
  { label:"$10 Prepay",fee:10, prepay:true,  color:getColor("$10 Prepay"),zips:["19082","19004","19074","19066","19036","19096","19018","19026","19113","19029"] },
  { label:"$15",       fee:15, prepay:false, color:getColor("$15"),       zips:["19128","19119","19138","19126","19135","19149","19012","19127"] },
  { label:"$15 Prepay",fee:15, prepay:true,  color:getColor("$15 Prepay"),zips:["19072","19003","19083","19078","19076","19043","19070","19033"] },
  { label:"$20",       fee:20, prepay:false, color:getColor("$20"),       zips:["19118","19150","19111","19136","19152"] },
  { label:"$20 Prepay",fee:20, prepay:true,  color:getColor("$20 Prepay"),
    zips:["19022","19094","19081","19064","19041","19010","19085","19428","19035","19027","19114","19115","19154","19116","19046","19038","19095","19444","19428","19020","19021","19007","19008"] }
];

function getColor(label){
  switch(label){
    case "Free Delivery": return cssVar('--free');
    case "$6": return cssVar('--fee-6');
    case "$6 Prepay": return cssVar('--fee-6-pre');
    case "$10": return cssVar('--fee-10');
    case "$10 Prepay": return cssVar('--fee-10-pre');
    case "$15": return cssVar('--fee-15');
    case "$15 Prepay": return cssVar('--fee-15-pre');
    case "$20": return cssVar('--fee-20');
    case "$20 Prepay": return cssVar('--fee-20-pre');
    default: return cssVar('--free');
  }
}
function cssVar(name){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return v || '#f5f5f5';
}

/** Lookup: ZIP -> {color,label,fee,prepay} */
const ZIP_STYLE = (() => {
  const m = new Map();
  ZIP_GROUPS.forEach(g => g.zips.forEach(z => m.set(String(z), { color: g.color, label: g.label, fee: g.fee, prepay: g.prepay })));
  return m;
})();

/* Neighborhood lookup (extend as needed) */
const ZIP_NEIGHBORHOOD = {
  "19106":"Old City","19107":"Center City East","19103":"Center City West","19102":"Center City West","19130":"Fairmount / Art Museum",
  "19123":"Northern Liberties","19125":"Fishtown","19122":"Olde Kensington / Temple","19133":"West Kensington","19134":"Port Richmond / Kensington","19137":"Bridesburg",
  "19145":"South Philly (West)","19146":"Graduate Hospital","19147":"Queen Village / Bella Vista","19148":"East Passyunk","19112":"Navy Yard",
  "19104":"University City","19139":"West Philly","19143":"Cedar Park / SW Philly","19151":"Overbrook","19131":"Wynnefield","19153":"Airport / Eastwick","19142":"Elmwood",
  "19121":"Brewerytown / Sharswood","19132":"Strawberry Mansion","19140":"Hunting Park","19141":"Logan","19120":"Feltonville / Lawncrest",
  "19129":"East Falls","19128":"Roxborough / Manayunk","19144":"Germantown","19119":"Mt. Airy","19118":"Chestnut Hill","19150":"West Oak Lane","19138":"East Germantown",
  "19124":"Frankford","19135":"Tacony","19136":"Holmesburg","19149":"Mayfair","19152":"Rhawnhurst","19111":"Fox Chase","19115":"Bustleton","19116":"Somerton","19114":"Torresdale",
  "19004":"Bala Cynwyd","19066":"Merion Station","19096":"Wynnewood","19072":"Narberth","19003":"Ardmore","19041":"Haverford","19010":"Bryn Mawr","19085":"Villanova","19035":"Gladwyne",
  "19082":"Upper Darby","19026":"Drexel Hill","19083":"Havertown","19033":"Folsom","19070":"Swarthmore","19078":"Ridley Park","19076":"Prospect Park","19074":"Norwood","19043":"Morton","19029":"Essington","19127":"Manayunk",
  "19007":"Bristol","19020":"Bensalem","19021":"Croydon","19027":"Elkins Park","19012":"Cheltenham","19046":"Jenkintown","19038":"Glenside","19095":"Wyncote","19428":"Conshohocken","19444":"Lafayette Hill","19008":"Broomall"
};
function getNeighborhoodForZip(zip){ return ZIP_NEIGHBORHOOD[String(zip)] || null; }

/* Minimal popup (neighborhood title, fee pill, prepay pill, zip chip) */
function popupHTML({ zip, label, prepay, neighborhood, color }) {
  const baseLabel = (label || 'Free Delivery').replace(/\s*Prepay$/, '');
  const title = neighborhood ? neighborhood : baseLabel;
  const leftPillText = (label === "Free Delivery" || baseLabel === "Free Delivery") ? "Free Delivery" : baseLabel;
  const feeDot = `<span class="dm-fee-dot" style="background:${color}"></span>`;
  return `
    <div class="dm-popup">
      <div class="dm-head">
    <div class="dm-title">${title}</div>
    <button class="dm-close" onclick="window.__closeInfo()">
      ✕<span class="sr-only">Close</span>
    </button>
  </div>
      <div class="dm-body">
        <div class="dm-rowline">
          <div class="dm-left">
            ${feeDot}
            <span class="dm-pill">${leftPillText}${prepay ? '<span class="dm-prepay">Prepay</span>' : ''}</span>
          </div>
          <span class="dm-pill dm-zip">${zip}</span>
        </div>
      </div>
    </div>
  `;
}

let lastHighlighted = null;
let marker = null;
let info = null;
      
let hoverLabelMarker = null;   // label-only marker for hover
let activeLegend = null;       // legend spotlight filter
window.__closeInfo = () => { if (info) info.close(); };


function initMap() {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 10,
    center: { lat: 39.9526, lng: -75.1652 }
  });

  // Map/Satellite control and search placement
  map.setOptions({
    mapTypeControl: true,
    mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT }
  });
  map.controls[google.maps.ControlPosition.TOP_LEFT]
    .push(document.getElementById('searchWrap'));

  info = new google.maps.InfoWindow({ disableAutoPan: false });
  // Hide default close button in case CSS loads late
info.addListener('domready', () => {
  document.querySelectorAll('.gm-ui-hover-effect').forEach(el => el.style.display = 'none');
});


  // ---- Data styling with spotlight support ----
  map.data.loadGeoJson('zip-map.json', null, () => {
    function baseOpacity(fee){
      return (fee >= 20) ? 0.45 :
             (fee >= 15) ? 0.35 :
             (fee >= 10) ? 0.30 :
             (fee >=  6) ? 0.28 : 0.22;  // free
    }
    function computeStyle(feature){
      const zip = getZipFromFeature(feature);
      const s = ZIP_STYLE.get(String(zip)) || {};
      const fee = s.fee ?? 0;
      const label = s.label || "Free Delivery";  // ensure Free Delivery can be spotlighted
      const color = s.color || getColor(label);

      let fillOpacity = baseOpacity(fee);
      let strokeColor = color;
      let strokeWeight = 1.5;

      if (activeLegend && (label !== activeLegend)) {
        fillOpacity = 0.08;
        strokeColor = '#c7c7c7';
        strokeWeight = 1;
      } else if (activeLegend) {
        strokeWeight = 2;
      }
      return { fillColor: color, fillOpacity, strokeColor, strokeWeight };
    }
    map.data.setStyle(computeStyle);
    window.__refreshZoneStyles = () => map.data.setStyle(computeStyle);
  });

  // Click → popup + strong highlight
  map.data.addListener('click', (e) => {
    const zip = getZipFromFeature(e.feature);
    const s = ZIP_STYLE.get(String(zip)) || {};
    highlightFeature(map, e.feature);
    const neighborhood = getNeighborhoodForZip(zip);
    info.setContent(popupHTML({
      zip,
      label: s.label || 'Free Delivery',
      prepay: !!s.prepay,
      neighborhood,
      color: s.color || getColor('Free Delivery')
    }));
    info.setPosition(e.latLng);
    info.open(map);
  });

  // Hover: thicken outline + centered ZIP label (label-only marker)
  map.data.addListener('mouseover', (e) => {
    const zip = getZipFromFeature(e.feature);
    map.data.overrideStyle(e.feature, { strokeWeight: 3, fillOpacity: 0.34 });
    const center = centerOfFeature(e.feature) || e.latLng;
    if (!hoverLabelMarker) {
      hoverLabelMarker = new google.maps.Marker({
        map,
        position: center,
        clickable: false,
        zIndex: 9999,
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0, strokeWeight: 0 },
        label: {
          text: String(zip),
          color: '#111',
          fontSize: '12px',
          fontWeight: '600',
          fontFamily: '"DM Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif'
        },
        optimized: false
      });
    } else {
      hoverLabelMarker.setPosition(center);
      hoverLabelMarker.setLabel({
        text: String(zip),
        color: '#111',
        fontSize: '12px',
        fontWeight: '600',
        fontFamily: '"DM Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif'
      });
      hoverLabelMarker.setMap(map);
    }
  });
  map.data.addListener('mousemove', (e) => {
    const center = centerOfFeature(e.feature) || e.latLng;
    if (hoverLabelMarker && center) hoverLabelMarker.setPosition(center);
  });
  map.data.addListener('mouseout', (e) => {
    if (lastHighlighted !== e.feature) map.data.revertStyle(e.feature);
    if (hoverLabelMarker) hoverLabelMarker.setMap(null);
  });

  // ---- Interactive legend (requested order) ----
  const ORDER = ["Free Delivery", "$6", "$6 Prepay", "$10", "$10 Prepay", "$15", "$15 Prepay", "$20", "$20 Prepay"];
  const groupsByLabel = (() => {
    const m = new Map();
    ZIP_GROUPS.forEach(g => m.set(g.label, g));
    if (!m.has("Free Delivery")) m.set("Free Delivery", { label:"Free Delivery", color:getColor("Free Delivery"), prepay:false, fee:0 });
    return m;
  })();

  const legend = document.createElement('div');
  legend.style.background = '#fff';
  legend.style.margin = '10px';
  legend.style.padding = '10px';
  legend.style.borderRadius = '10px';
  legend.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
  legend.style.font = '13px/1.3 "DM Sans", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';

  const title = document.createElement('div');
  title.style.fontWeight = '700';
  title.style.marginBottom = '6px';
  title.textContent = 'Service Areas';
  legend.appendChild(title);

  ORDER.forEach(label => {
    const g = groupsByLabel.get(label);
    if (!g) return;

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.setAttribute('data-label', g.label);
    btn.style.display = 'flex';
    btn.style.alignItems = 'center';
    btn.style.gap = '8px';
    btn.style.width = '100%';
    btn.style.margin = '4px 0';
    btn.style.padding = '6px 8px';
    btn.style.border = '1px solid rgba(0,0,0,.08)';
    btn.style.borderRadius = '8px';
    btn.style.background = '#fff';
    btn.style.cursor = 'pointer';
    btn.style.textAlign = 'left';

    const swatch = document.createElement('span');
    swatch.style.display = 'inline-block';
    swatch.style.width = '14px';
    swatch.style.height = '14px';
    swatch.style.borderRadius = '3px';
    swatch.style.background = g.color;
    swatch.style.border = '1px solid rgba(0,0,0,.12)';

    const baseLabelText = g.label.replace(' Prepay', '');
    const text = document.createElement('span');
    text.textContent = baseLabelText;
    text.style.fontWeight = 600;

    btn.appendChild(swatch);
    btn.appendChild(text);

    if (g.prepay) {
      const pill = document.createElement('span');
      pill.textContent = 'Prepay';
      pill.style.marginLeft = '6px';
      pill.style.background = '#fff8e1';
      pill.style.color = '#8b5e00';
      pill.style.border = '1px solid #f5d565';
      pill.style.borderRadius = '999px';
      pill.style.padding = '0 6px';
      pill.style.fontSize = '11px';
      pill.style.fontWeight = '700';
      btn.appendChild(pill);
    }

    btn.addEventListener('click', () => {
      const clicked = btn.getAttribute('data-label');
      activeLegend = (activeLegend === clicked) ? null : clicked;

      legend.querySelectorAll('[data-label]').forEach(el => {
        const isActive = el.getAttribute('data-label') === activeLegend;
        el.style.outline = isActive ? '2px solid #111827' : 'none';
        el.style.background = isActive ? 'rgba(0,0,0,0.04)' : '#fff';
      });

      if (window.__refreshZoneStyles) window.__refreshZoneStyles();
      if (typeof clearHighlight === 'function') clearHighlight(map);
    });

    legend.appendChild(btn);
  });

  map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);

  // ---- Autocomplete (Philly + South NJ bias) ----
  const phillySJBounds = new google.maps.LatLngBounds(
    { lat: 39.35, lng: -75.85 },
    { lat: 40.40, lng: -74.20 }
  );
  const input = document.getElementById('search');
  const ac = new google.maps.places.Autocomplete(input, {
    fields: ['geometry','formatted_address','address_components','place_id'],
    bounds: phillySJBounds,
    strictBounds: false,
    types: ['address'],
    componentRestrictions: { country: ['us'] }
  });
  const geocoder = new google.maps.Geocoder();

  const clearEl = document.getElementById('clearBtn');
  if (clearEl) {
    clearEl.addEventListener('click', () => {
      input.value = '';
      input.focus();
      if (marker) { marker.setMap(null); marker = null; }
      clearHighlight(map);
      info.close();
      if (hoverLabelMarker) hoverLabelMarker.setMap(null);
      activeLegend = null;
      legend.querySelectorAll('[data-label]').forEach(el => { el.style.outline = 'none'; el.style.background = '#fff'; });
      if (window.__refreshZoneStyles) window.__refreshZoneStyles();
    });
  }

// Search handler — camera stays on the address
ac.addListener('place_changed', async () => {
  const place = ac.getPlace();
  let location = place?.geometry?.location || null;
  const isStreetAddress = (place.address_components || []).some(c => c.types.includes('street_number'));

  if (!location || !isStreetAddress) {
    try {
      const q = input.value.trim();
      const { results } = await geocoder.geocode({
        address: q, bounds: phillySJBounds, componentRestrictions: { country: 'US' }
      });
      if (results && results[0]?.geometry?.location) location = results[0].geometry.location;
    } catch (_) {}
  }
  if (!location) return;

  if (!marker) marker = new google.maps.Marker({ map, position: location });
  else marker.setPosition(location);

  // Always pan + zoom manually so we never jump to wrong viewport
  map.panTo(location);
  map.setZoom(17);

  const containing = findContainingFeature(map, location);
  if (containing) {
    highlightFeature(map, containing);
    const zip = getZipFromFeature(containing);
    const s = ZIP_STYLE.get(String(zip)) || {};
    const neighborhood = getNeighborhoodForZip(zip);

    info.setContent(popupHTML({
      zip,
      label: s.label || 'Free Delivery',
      prepay: !!s.prepay,
      neighborhood,
      color: s.color || getColor('Free Delivery')
    }));
    info.setPosition(location);
    info.open(map);
  } else {
    clearHighlight(map);
    info.setContent(popupHTML({
      zip: '—',
      label: 'Free Delivery',
      prepay: false,
      neighborhood: null,
      color: getColor('Free Delivery')
    }));
    info.setPosition(location);
    info.open(map);
  }
});

}

// Expose callback globally
window.initMap = initMap;

/* Helpers */
function getZipFromFeature(feature){
  return feature.getProperty('ZCTA5CE20') || feature.getProperty('ZCTA5CE10') || feature.getProperty('GEOID');
}
function highlightFeature(map, feature){
  clearHighlight(map);
  lastHighlighted = feature;
  map.data.overrideStyle(feature, { fillOpacity: 0.6, strokeWeight: 4, zIndex: 1000 });
}
function clearHighlight(map){
  if (lastHighlighted){ map.data.revertStyle(lastHighlighted); lastHighlighted = null; }
}
function findContainingFeature(map, latLng){
  let found = null;
  map.data.forEach(f => { if (featureContainsLatLng(f, latLng)) found = f; });
  return found;
}
function featureContainsLatLng(feature, latLng){
  const geom = feature.getGeometry();
  let inside = false;
  const walk = (g) => {
    const t = g.getType();
    if (t === 'Polygon'){
      const paths = g.getArray().map(r => r.getArray());
      const poly = new google.maps.Polygon({ paths });
      if (google.maps.geometry.poly.containsLocation(latLng, poly)) inside = true;
    } else if (t === 'MultiPolygon' || t === 'GeometryCollection'){
      g.getArray().forEach(walk);
    }
  };
  walk(geom);
  return inside;
}
/* Bounds center as robust centroid */
function centerOfFeature(feature){
  const bounds = new google.maps.LatLngBounds();
  let has = false;
  const walk = (g) => {
    const t = g.getType();
    if (t === 'Polygon'){
      g.getArray().forEach(ring => ring.getArray().forEach(pt => { bounds.extend(pt); has = true; }));
    } else if (t === 'MultiPolygon' || t === 'GeometryCollection'){
      g.getArray().forEach(walk);
    } else if (t === 'Point'){
      bounds.extend(g.get()); has = true;
    }
  };
  walk(feature.getGeometry());
  return has ? bounds.getCenter() : null;
}
    </script>

    <!-- Loader: Maps + Places + Geometry -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDihHSv5KORtpnnMC7umGgXWBJm5NSduc8&callback=initMap&loading=async&libraries=places,geometry">
    </script>
  </head>

  <body>
    <!-- Search control (placed in TOP_LEFT by initMap) -->
    <div id="searchWrap">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.71.71l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
      </svg>
      <input id="search" type="text" placeholder="Search an address (Philly + South NJ)" />
      <button id="clearBtn" title="Clear">✕</button>
    </div>

    <div id="map"></div>
  
<!-- === Advanced Overlays: Heatmaps (Orders/AOV), Drive Times, Fee Simulator === -->
<style>
.dm-tools{position:absolute;top:12px;left:12px;z-index:10002;display:flex;gap:8px;flex-wrap:wrap}
.dm-tool{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:6px 10px;font-size:12px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.08);}
.dm-tool.active{background:#111827;color:#fff;border-color:#111827;}

.dm-modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10010;}
.dm-modal.open{display:flex;}
.dm-card{background:#fff;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);max-width:520px;width:92vw;border:1px solid #e5e7eb;overflow:hidden}
.dm-card h3{margin:0;padding:14px 16px;border-bottom:1px solid #f3f4f6;font-size:16px}
.dm-card .body{padding:14px 16px;display:grid;gap:12px}
.dm-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.dm-field label{font-size:12px;color:#6b7280;display:block;margin-bottom:6px}
.dm-field input{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:14px}
.dm-actions{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #f3f4f6}
.dm-btn2{appearance:none;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
.dm-btn2.primary{background:#111827;color:#fff}
.dm-btn2.ghost{background:#f3f4f6;color:#111827}

.dm-legend{position:absolute;bottom:14px;left:12px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:12px;display:none;gap:8px;align-items:center}
.dm-legend.show{display:flex;}
.dm-chip{display:inline-block;width:12px;height:12px;border-radius:2px}
.dm-chip.l1{background:#e0ecf8} .dm-chip.l2{background:#b3d4f1} .dm-chip.l3{background:#7fb9e8} .dm-chip.l4{background:#4a9ede} .dm-chip.l5{background:#1e88e5}
</style>

<div class="dm-tools">
  <button id="toolHeatOrders" class="dm-tool">Heat: Orders</button>
  <button id="toolHeatAOV" class="dm-tool">Heat: AOV</button>
  <button id="toolDriveTimes" class="dm-tool">Drive Times</button>
  <button id="toolFeeSim" class="dm-tool">Fee Simulator</button>
</div>

<div id="dmLegend" class="dm-legend">
  <span class="dm-chip l1"></span><span class="dm-chip l2"></span><span class="dm-chip l3"></span><span class="dm-chip l4"></span><span class="dm-chip l5"></span>
  <span id="legendLabel">Low → High</span>
</div>

<div id="dmModal" class="dm-modal" role="dialog" aria-modal="true" aria-labelledby="dmModalTitle">
  <div class="dm-card">
    <h3 id="dmModalTitle">Fee Simulator (this ZIP)</h3>
    <div class="body">
      <div class="dm-grid">
        <div class="dm-field">
          <label>Current Delivery Fee ($)</label>
          <input id="fs_fee" type="number" step="0.5" value="5">
        </div>
        <div class="dm-field">
          <label>Change (Δ$)</label>
          <input id="fs_delta" type="number" step="0.5" value="0">
        </div>
        <div class="dm-field">
          <label>Elasticity (% orders change per +$1)</label>
          <input id="fs_elasticity" type="number" step="0.01" value="-0.07">
        </div>
        <div class="dm-field">
          <label>Cost per Delivery ($)</label>
          <input id="fs_cost" type="number" step="0.5" value="6">
        </div>
      </div>
      <div class="dm-grid">
        <div class="dm-field">
          <label>Baseline Orders (est.)</label>
          <input id="fs_orders" type="number" step="1" value="100">
        </div>
        <div class="dm-field">
          <label>Average Order Value (AOV)</label>
          <input id="fs_aov" type="number" step="0.5" value="65">
        </div>
      </div>
      <div id="fs_result" style="font-size:13px;color:#111827"></div>
    </div>
    <div class="dm-actions">
      <button class="dm-btn2 ghost" onclick="DM_MODAL_CLOSE()">Close</button>
      <button class="dm-btn2 primary" onclick="DM_RUN_SIM()">Run</button>
    </div>
  </div>
</div>

<script>
const ZIP_METRICS = {"07205":{"orders":5.0,"aov":0.0},"07628":{"orders":1.0,"aov":0.0},"07882":{"orders":7.0,"aov":0.0},"08002":{"orders":108.0,"aov":0.0},"08003":{"orders":8.0,"aov":0.0},"08004":{"orders":29.0,"aov":0.0},"08007":{"orders":12.0,"aov":0.0},"08009":{"orders":34.0,"aov":0.0},"08010":{"orders":46.0,"aov":0.0},"08012":{"orders":130.0,"aov":0.0},"08016":{"orders":53.0,"aov":0.0},"08020":{"orders":1.0,"aov":0.0},"08021":{"orders":217.0,"aov":0.0},"08028":{"orders":15.0,"aov":0.0},"08029":{"orders":22.0,"aov":0.0},"08030":{"orders":26.0,"aov":0.0},"08031":{"orders":126.0,"aov":0.0},"08033":{"orders":66.0,"aov":0.0},"08034":{"orders":17.0,"aov":0.0},"08035":{"orders":100.0,"aov":0.0},"08043":{"orders":400.0,"aov":0.0},"08045":{"orders":29.0,"aov":0.0},"08046":{"orders":49.0,"aov":0.0},"08049":{"orders":35.0,"aov":0.0},"08051":{"orders":103.0,"aov":0.0},"08052":{"orders":260.0,"aov":0.0},"08053":{"orders":567.0,"aov":0.0},"08054":{"orders":253.0,"aov":0.0},"08055":{"orders":213.0,"aov":0.0},"08057":{"orders":69.0,"aov":0.0},"08059":{"orders":4.0,"aov":0.0},"08060":{"orders":102.0,"aov":0.0},"08061":{"orders":4.0,"aov":0.0},"08062":{"orders":41.0,"aov":0.0},"08065":{"orders":1.0,"aov":0.0},"08066":{"orders":31.0,"aov":0.0},"08068":{"orders":70.0,"aov":0.0},"08070":{"orders":7.0,"aov":0.0},"08071":{"orders":2.0,"aov":0.0},"08075":{"orders":44.0,"aov":0.0},"08077":{"orders":406.0,"aov":0.0},"08078":{"orders":1.0,"aov":0.0},"08080":{"orders":34.0,"aov":0.0},"08081":{"orders":55.0,"aov":0.0},"08083":{"orders":120.0,"aov":0.0},"08085":{"orders":9.0,"aov":0.0},"08086":{"orders":105.0,"aov":0.0},"08088":{"orders":11.0,"aov":0.0},"08089":{"orders":2.0,"aov":0.0},"08090":{"orders":61.0,"aov":0.0},"08091":{"orders":115.0,"aov":0.0},"08093":{"orders":476.0,"aov":0.0},"08094":{"orders":6.0,"aov":0.0},"08096":{"orders":323.0,"aov":0.0},"08097":{"orders":7.0,"aov":0.0},"08104":{"orders":34.0,"aov":0.0},"08106":{"orders":179.0,"aov":0.0},"08107":{"orders":30.0,"aov":0.0},"08108":{"orders":196.0,"aov":0.0},"08109":{"orders":131.0,"aov":0.0},"08110":{"orders":125.0,"aov":0.0},"08312":{"orders":13.0,"aov":0.0},"08318":{"orders":5.0,"aov":0.0},"08322":{"orders":55.0,"aov":0.0},"08505":{"orders":7.0,"aov":0.0},"08518":{"orders":17.0,"aov":0.0},"08742":{"orders":11.0,"aov":0.0},"08833":{"orders":2.0,"aov":0.0},"08971":{"orders":57.0,"aov":0.0},"10003":{"orders":1.0,"aov":0.0},"19001":{"orders":12.0,"aov":0.0},"19003":{"orders":45.0,"aov":0.0},"19004":{"orders":207.0,"aov":0.0},"19012":{"orders":2.0,"aov":0.0},"19018":{"orders":22.0,"aov":0.0},"19020":{"orders":24.0,"aov":0.0},"19023":{"orders":14.0,"aov":0.0},"19027":{"orders":164.0,"aov":0.0},"19032":{"orders":13.0,"aov":0.0},"19036":{"orders":13.0,"aov":0.0},"19038":{"orders":99.0,"aov":0.0},"19046":{"orders":77.0,"aov":0.0},"19050":{"orders":226.0,"aov":0.0},"19061":{"orders":23.0,"aov":0.0},"19067":{"orders":14.0,"aov":0.0},"19072":{"orders":41.0,"aov":0.0},"19073":{"orders":28.0,"aov":0.0},"19082":{"orders":179.0,"aov":0.0},"19083":{"orders":5.0,"aov":0.0},"19086":{"orders":1.0,"aov":0.0},"19095":{"orders":3.0,"aov":0.0},"19096":{"orders":83.0,"aov":0.0},"19102":{"orders":884.0,"aov":0.0},"19103":{"orders":2575.0,"aov":0.0},"19104":{"orders":4652.0,"aov":0.0},"19106":{"orders":1470.0,"aov":0.0},"19107":{"orders":3026.0,"aov":0.0},"19111":{"orders":286.0,"aov":0.0},"19115":{"orders":64.0,"aov":0.0},"19116":{"orders":10.0,"aov":0.0},"19118":{"orders":88.0,"aov":0.0},"19119":{"orders":212.0,"aov":0.0},"19120":{"orders":326.0,"aov":0.0},"19121":{"orders":5229.0,"aov":0.0},"19122":{"orders":5485.0,"aov":0.0},"19123":{"orders":4811.0,"aov":0.0},"19124":{"orders":435.0,"aov":0.0},"19125":{"orders":4794.0,"aov":0.0},"19126":{"orders":135.0,"aov":0.0},"19127":{"orders":488.0,"aov":0.0},"19128":{"orders":1877.0,"aov":0.0},"19129":{"orders":347.0,"aov":0.0},"19130":{"orders":5763.0,"aov":0.0},"19131":{"orders":1687.0,"aov":0.0},"19132":{"orders":2074.0,"aov":0.0},"19133":{"orders":649.0,"aov":0.0},"19134":{"orders":3441.0,"aov":0.0},"19135":{"orders":129.0,"aov":0.0},"19136":{"orders":63.0,"aov":0.0},"19137":{"orders":48.0,"aov":0.0},"19138":{"orders":229.0,"aov":0.0},"19139":{"orders":3629.0,"aov":0.0},"19140":{"orders":552.0,"aov":0.0},"19141":{"orders":133.0,"aov":0.0},"19142":{"orders":157.0,"aov":0.0},"19143":{"orders":6752.0,"aov":0.0},"19144":{"orders":1698.0,"aov":0.0},"19145":{"orders":7110.0,"aov":0.0},"19146":{"orders":10273.0,"aov":0.0},"19147":{"orders":9628.0,"aov":0.0},"19148":{"orders":6602.0,"aov":0.0},"19149":{"orders":219.0,"aov":0.0},"19150":{"orders":62.0,"aov":0.0},"19151":{"orders":1164.0,"aov":0.0},"19152":{"orders":2.0,"aov":0.0},"19153":{"orders":457.0,"aov":0.0},"19154":{"orders":15.0,"aov":0.0},"19301":{"orders":7.0,"aov":0.0},"19312":{"orders":9.0,"aov":0.0},"19380":{"orders":1.0,"aov":0.0},"19401":{"orders":154.0,"aov":0.0},"19403":{"orders":85.0,"aov":0.0},"19428":{"orders":10.0,"aov":0.0},"19530":{"orders":1.0,"aov":0.0},"19803":{"orders":1.0,"aov":0.0},"22044":{"orders":1.0,"aov":0.0},"23503":{"orders":14.0,"aov":0.0},"28560":{"orders":52.0,"aov":0.0},"29407":{"orders":7.0,"aov":0.0},"33467":{"orders":4.0,"aov":0.0}};

// Heatmaps
let heatOrders = null, heatAOV = null;
let zipCentersCache = JSON.parse(localStorage.getItem('dm_zip_centers') || '{}');
const geocoder = (window.google && google.maps && google.maps.Geocoder) ? new google.maps.Geocoder() : null;

function DM_getZipLatLng(zip, cb){
  const cached = zipCentersCache[zip];
  if (cached && cached.lat && cached.lng) { cb(new google.maps.LatLng(cached.lat, cached.lng)); return; }
  if (!geocoder || !geocoder.geocode) { cb(null); return; }
  geocoder.geocode({ address: zip, componentRestrictions: { country: 'US' } }, (res, status) => {
    if (status === 'OK' && res[0]) {
      const loc = res[0].geometry.location;
      zipCentersCache[zip] = {lat: loc.lat(), lng: loc.lng()};
      localStorage.setItem('dm_zip_centers', JSON.stringify(zipCentersCache));
      cb(loc);
    } else {
      cb(null);
    }
  });
}

function DM_buildHeat(layerType){
  if (!window.google || !google.maps.visualization) { alert('Google Maps visualization library not loaded.'); return Promise.resolve(null); }
  const zips = Object.keys(window.ZIP_SUMMARY || {});
  const promises = zips.map(zip => new Promise(resolve => DM_getZipLatLng(zip, loc => resolve([zip, loc]))));
  return Promise.all(promises).then(list => {
    const data = [];
    list.forEach(([zip, loc]) => {
      if (!loc) return;
      const metrics = ZIP_METRICS[zip] || {orders:0, aov:0};
      let weight = 0;
      if (layerType === 'orders') weight = Math.max(0, metrics.orders || 0);
      if (layerType === 'aov') weight = Math.max(0, metrics.aov || 0);
      if (weight>0) data.push({location: loc, weight: weight});
    });
    const hm = new google.maps.visualization.HeatmapLayer({
      data: data, dissipating: true, radius: 38, opacity: 0.65
    });
    hm.setMap(window.__map || window.map);
    return hm;
  });
}

function DM_toggleHeat(type, btn){
  if (!window.google || !google.maps.visualization) { alert('Google Maps visualization library not loaded.'); return; }
  const legend = document.getElementById('dmLegend');
  if (type === 'orders') {
    if (heatOrders) { heatOrders.setMap(null); heatOrders = null; btn.classList.remove('active'); legend.classList.remove('show'); }
    else {
      if (heatAOV) { heatAOV.setMap(null); heatAOV = null; document.getElementById('toolHeatAOV').classList.remove('active'); }
      btn.classList.add('active'); legend.classList.add('show'); document.getElementById('legendLabel').textContent = 'Orders: Low → High';
      DM_buildHeat('orders').then(hm => heatOrders = hm);
    }
  } else if (type === 'aov') {
    if (heatAOV) { heatAOV.setMap(null); heatAOV = null; btn.classList.remove('active'); legend.classList.remove('show'); }
    else {
      if (heatOrders) { heatOrders.setMap(null); heatOrders = null; document.getElementById('toolHeatOrders').classList.remove('active'); }
      btn.classList.add('active'); legend.classList.add('show'); document.getElementById('legendLabel').textContent = 'AOV: Low → High';
      DM_buildHeat('aov').then(hm => heatAOV = hm);
    }
  }
}

// Drive times
const ORIGIN_ADDR = '2300 Washington Avenue, Philadelphia, PA';
let driveLabels = []; let rings = [];

function DM_clearDrive(){
  driveLabels.forEach(x => x.setMap && x.setMap(null)); driveLabels = [];
  rings.forEach(x => x.setMap && x.setMap(null)); rings = [];
  document.getElementById('toolDriveTimes').classList.remove('active');
}

function DM_drawRings(center){
  const map = window.__map || window.map;
  [10,20,30].forEach(min => {
    const circle = new google.maps.Circle({
      map, center, radius: min*1000,
      strokeColor: '#111827', strokeOpacity: 0.18, strokeWeight: 1, fillOpacity: 0
    });
    rings.push(circle);
  });
}

function DM_driveTimes(btn){
  if (!window.google || !google.maps.DistanceMatrixService) { alert('Google Distance Matrix not available.'); return; }
  if (driveLabels.length) { DM_clearDrive(); return; }
  btn.classList.add('active');

  const dm = new google.maps.DistanceMatrixService();
  const gc = new google.maps.Geocoder();
  gc.geocode({address: ORIGIN_ADDR}, (res, status) => {
    if (status !== 'OK' || !res[0]) return;
    const originLoc = res[0].geometry.location;
    DM_drawRings(originLoc);

    const zips = Object.keys(window.ZIP_SUMMARY||{});
    const chunks = []; let temp = [];
    zips.forEach((z,i)=>{ temp.push(z); if(temp.length===20||i===zips.length-1){ chunks.push(temp); temp=[]; }});

    const cache = JSON.parse(localStorage.getItem('dm_drive_times')||'{}');

    const processChunk = (idx) => {
      if (idx >= chunks.length) return;
      const chunk = chunks[idx];
      const destPromises = chunk.map(zip => new Promise(resolve => DM_getZipLatLng(zip, loc => resolve([zip, loc]))));
      Promise.all(destPromises).then(list => {
        const destinations = list.map(([zip, loc]) => loc || zip);
        dm.getDistanceMatrix({ origins: [originLoc], destinations, travelMode: 'DRIVING' }, (resp, stat) => {
          if (stat === 'OK' && resp.rows && resp.rows[0]) {
            resp.rows[0].elements.forEach((el, i2) => {
              const zip = chunk[i2];
              if (el.status === 'OK') {
                const mins = Math.round(el.duration.value/60);
                cache[zip] = mins;
                const loc = list[i2][1];
                if (loc) {
                  const iw = new google.maps.InfoWindow({content: "<div style='font-size:11px;font-weight:700;background:#111827;color:#fff;padding:4px 6px;border-radius:6px;'>"+mins+"m</div>", position: loc});
                  iw.open(window.__map || window.map);
                  driveLabels.push(iw);
                }
              }
            });
            localStorage.setItem('dm_drive_times', JSON.stringify(cache));
          }
          processChunk(idx+1);
        });
      });
    };
    processChunk(0);
  });
}

// Fee simulator
let currentZipForSim = null;
let modal = null;
window.addEventListener('DOMContentLoaded', function(){ modal = document.getElementById('dmModal'); });

function DM_MODAL_OPEN(zip){
  currentZipForSim = zip;
  var title = document.getElementById('dmModalTitle');
  if (title) title.textContent = 'Fee Simulator (' + zip + ')';
  var m = ZIP_METRICS[zip];
  if (m && m.aov) document.getElementById('fs_aov').value = m.aov;
  document.getElementById('fs_result').innerHTML = '';
  if (modal) modal.classList.add('open');
}
function DM_MODAL_CLOSE(){ if (modal) modal.classList.remove('open'); }
function DM_RUN_SIM(){
  var fee = parseFloat(document.getElementById('fs_fee').value||'0');
  var delta = parseFloat(document.getElementById('fs_delta').value||'0');
  var elasticity = parseFloat(document.getElementById('fs_elasticity').value||'-0.07');
  var cost = parseFloat(document.getElementById('fs_cost').value||'6');
  var baseOrders = parseFloat(document.getElementById('fs_orders').value||'100');
  var aov = parseFloat(document.getElementById('fs_aov').value||'65');

  var pctChange = elasticity * delta;
  var newOrders = Math.max(0, Math.round(baseOrders * (1 + pctChange)));
  var newFee = Math.max(0, fee + delta);

  var revMerch = newOrders * aov;
  var revFee = newOrders * newFee;
  var costDel = newOrders * cost;
  var profit = revMerch + revFee - costDel;

  document.getElementById('fs_result').innerHTML =
    "<div><b>Projected Orders:</b> " + newOrders + "</div>" +
    "<div><b>Projected Fee:</b> " + newFee.toFixed(2) + "</div>" +
    "<div><b>Revenue (Merch):</b> " + revMerch.toFixed(2) + "</div>" +
    "<div><b>Revenue (Fees):</b> " + revFee.toFixed(2) + "</div>" +
    "<div><b>Delivery Cost:</b> -" + costDel.toFixed(2) + "</div>" +
    "<hr/><div style='font-size:15px'><b>Projected Profit:</b> " + profit.toFixed(2) + "</div>";
}

// Wire buttons
window.addEventListener('DOMContentLoaded', function(){
  var o = document.getElementById('toolHeatOrders');
  var a = document.getElementById('toolHeatAOV');
  var d = document.getElementById('toolDriveTimes');
  var f = document.getElementById('toolFeeSim');
  if (o) o.onclick = function(){ DM_toggleHeat('orders', o); };
  if (a) a.onclick = function(){ DM_toggleHeat('aov', a); };
  if (d) d.onclick = function(){ DM_driveTimes(d); };
  if (f) f.onclick = function(){ DM_MODAL_OPEN(window.__lastZip || 'Current ZIP'); };
});

// Record last clicked zip for Fee Sim default (if popupHTML exists)
var __popup_prev2 = window.popupHTML;
if (typeof __popup_prev2 === 'function'){
  window.popupHTML = function(args){
    window.__lastZip = String(args.zip);
    return __popup_prev2(args);
  };
}
</script>

</body>
</html>
