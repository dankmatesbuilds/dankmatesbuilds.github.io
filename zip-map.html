<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dankmates Delivery Zones</title>
    <style>
      :root{
        --bg:#ffffff; --text:#111827; --muted:#6b7280;
        --ring:rgba(37,99,235,.25);
        --shadow:0 8px 24px rgba(0,0,0,.12); --radius:14px;

        /* Zone colors (kept from your file) */
        --free:#A2DD9B;         /* light green */
        --fee-6:#FFE770;        /* light yellow */
        --fee-6-pre:#FFDD31;    /* slightly darker yellow */
        --fee-10:#FFB43A;       /* medium yellow */
        --fee-10-pre:#FF9E20;   /* medium-dark yellow */
        --fee-15:#FC6722;       /* orange */
        --fee-15-pre:#FF5100;   /* darker orange */
        --fee-20:#ED0101;       /* red */
        --fee-20-pre:#D10000;   /* darker red */
      }
      html,body{height:100%;margin:0;}
      #map{height:100%;width:100%;}

      /* Search control (placed in TOP_LEFT by JS) */
      #searchWrap{
        display:flex; align-items:center; gap:8px;
        background:var(--bg); color:var(--text);
        border-radius:var(--radius); padding:10px 12px;
        box-shadow:var(--shadow); border:1px solid #e5e7eb;
        margin:10px;
      }
      #searchWrap .icon{width:18px;height:18px;fill:var(--muted);}
      #search{width:320px;max-width:62vw;border:none;outline:none;font-size:14px;color:var(--text);background:transparent;}
      #search::placeholder{color:#9ca3af;}
      #searchWrap:focus-within{box-shadow:var(--shadow),0 0 0 4px var(--ring);border-color:#d1d5db;}
      #clearBtn{appearance:none;border:none;background:#f3f4f6;color:#6b7280;width:26px;height:26px;border-radius:8px;cursor:pointer;line-height:26px;text-align:center;font-size:14px;}
      #clearBtn:hover{background:#e5e7eb;}

      /* --- Minimal, Apple-ish popup card --- */
      .dm-popup{
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color:#0b0b0c;
        min-width: 220px; max-width: 320px;
        background: rgba(255,255,255,0.92);
        backdrop-filter: saturate(180%) blur(10px);
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,.12);
        overflow: hidden;
      }
      .dm-head{
        display:flex; justify-content:space-between; align-items:center;
        padding:12px 14px;
        background: linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.6));
      }
      .dm-title{
        font-size: 16px; font-weight: 700; letter-spacing: .2px;
      }
      .dm-chiprow{ display:flex; gap:8px; align-items:center; }
      .dm-chip{
        display:inline-flex; align-items:center; gap:6px;
        height: 22px; padding:0 8px; border-radius: 999px;
        border: 1px solid rgba(0,0,0,.12);
        background:#fff; font-size:12px; font-weight:600;
      }
      .dm-chip.zip{ background:#111827; color:#fff; border-color:#111827; }
      .dm-chip.prepay{ background:#fff8e1; color:#8b5e00; border-color:#f5d565; }
      .dm-body{ display:none; } /* no body needed */
    </style>

    <script>
/** NEW GROUPS — label is the fee; prepay indicates prepayment zones */
const ZIP_GROUPS = [
  /* $6 */
  { label:"$6",        fee:6,  prepay:false, color:getColor("$6"),        zips:["19153","19131","19151","19140","19134","19129","19142"] },

  /* $6 Prepay */
  { label:"$6 Prepay", fee:6,  prepay:true,  color:getColor("$6 Prepay"), zips:["19032","19079","19023","19050"] },

  /* $10 */
  { label:"$10",       fee:10, prepay:false, color:getColor("$10"),       zips:["19144","19141","19120","19124","19137" /* 19127 moved to $15 */] },

  /* $10 Prepay */
  { label:"$10 Prepay",fee:10, prepay:true,  color:getColor("$10 Prepay"),zips:["19082","19004","19074","19066","19036","19096","19018","19026","19113","19029"] },

  /* $15 */
  { label:"$15",       fee:15, prepay:false, color:getColor("$15"),       zips:["19128","19119","19138","19126","19135","19149","19012","19127"] },

  /* $15 Prepay */
  { label:"$15 Prepay",fee:15, prepay:true,  color:getColor("$15 Prepay"),zips:["19072","19003","19083","19078","19076","19043","19070","19033"] },

  /* $20 */
  { label:"$20",       fee:20, prepay:false, color:getColor("$20"),       zips:["19118","19150","19111","19136","19152"] },

  /* $20 Prepay */
  { label:"$20 Prepay",fee:20, prepay:true,  color:getColor("$20 Prepay"),
    zips:[
      "19022","19094","19081","19064","19041","19010","19085","19428","19035","19027",
      "19114","19115","19154","19116","19046","19038","19095","19444","19428","19020","19021","19007","19008"
    ]
  }
];

/* Pull CSS vars for palette */
function getColor(label){
  switch(label){
    case "Free Delivery": return cssVar('--free');
    case "$6": return cssVar('--fee-6');
    case "$6 Prepay": return cssVar('--fee-6-pre');
    case "$10": return cssVar('--fee-10');
    case "$10 Prepay": return cssVar('--fee-10-pre');
    case "$15": return cssVar('--fee-15');
    case "$15 Prepay": return cssVar('--fee-15-pre');
    case "$20": return cssVar('--fee-20');
    case "$20 Prepay": return cssVar('--fee-20-pre');
    default: return cssVar('--free');
  }
}
function cssVar(name){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return v || '#f5f5f5';
}

/** Lookup: ZIP -> {color,label,fee,prepay} */
const ZIP_STYLE = (() => {
  const m = new Map();
  ZIP_GROUPS.forEach(g => g.zips.forEach(z => m.set(String(z), { color: g.color, label: g.label, fee: g.fee, prepay: g.prepay })));
  return m;
})();

/* Minimal popup template */
function popupHTML({ zip, label, prepay }) {
  return `
    <div class="dm-popup">
      <div class="dm-head">
        <div class="dm-title">${label || 'Free Delivery'}</div>
        <div class="dm-chiprow">
          ${prepay ? `<span class="dm-chip prepay">Prepay</span>` : ``}
          <span class="dm-chip zip">${zip}</span>
        </div>
      </div>
      <div class="dm-body"></div>
    </div>
  `;
}

let lastHighlighted = null;
let marker = null;
let info = null;
let hoverLabelMarker = null;   // label-only marker for hover
let activeLegend = null;       // legend spotlight filter

function initMap() {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 10,
    center: { lat: 39.9526, lng: -75.1652 }
  });

  // Map/Satellite control and search placement
  map.setOptions({
    mapTypeControl: true,
    mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT }
  });
  map.controls[google.maps.ControlPosition.TOP_LEFT]
    .push(document.getElementById('searchWrap'));

  info = new google.maps.InfoWindow();

  // ---- Data styling with spotlight support ----
  map.data.loadGeoJson('zip-map.json', null, () => {
    function baseOpacity(fee){
      return (fee >= 20) ? 0.45 :
             (fee >= 15) ? 0.35 :
             (fee >= 10) ? 0.30 :
             (fee >=  6) ? 0.28 : 0.22;  // free
    }
    function computeStyle(feature){
      const zip = getZipFromFeature(feature);
      const s = ZIP_STYLE.get(String(zip)) || {};
      const fee   = s.fee   ?? 0;
      const color = s.color ?? getColor("Free Delivery");
      let fillOpacity = baseOpacity(fee);
      let strokeColor = color;
      let strokeWeight = 1.5;

      // Spotlight: dim non-matching when a legend filter is active
      if (activeLegend && (s.label !== activeLegend)) {
        fillOpacity = 0.08;
        strokeColor = '#c7c7c7';
        strokeWeight = 1;
      } else if (activeLegend) {
        strokeWeight = 2; // subtle emphasis on matching zones
      }
      return { fillColor: color, fillOpacity, strokeColor, strokeWeight };
    }
    map.data.setStyle(computeStyle);

    // expose for legend refresh
    window.__refreshZoneStyles = () => map.data.setStyle(computeStyle);
  });

  // Click → popup + strong highlight
  map.data.addListener('click', (e) => {
    const zip = getZipFromFeature(e.feature);
    const s = ZIP_STYLE.get(String(zip)) || {};
    highlightFeature(map, e.feature);
    info.setContent(popupHTML({
      zip,
      label: s.label || 'Free Delivery',
      prepay: !!s.prepay
    }));
    info.setPosition(e.latLng);
    info.open(map);
  });

  // Hover: thicken outline + ZIP label (label-only marker)
  map.data.addListener('mouseover', (e) => {
    const zip = getZipFromFeature(e.feature);
    map.data.overrideStyle(e.feature, { strokeWeight: 3, fillOpacity: 0.34 });

    const center = centerOfFeature(e.feature) || e.latLng;
    if (!hoverLabelMarker) {
      hoverLabelMarker = new google.maps.Marker({
        map,
        position: center,
        clickable: false,
        zIndex: 9999,
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0, strokeWeight: 0 },
        label: {
          text: String(zip),
          color: '#111',
          fontSize: '12px',
          fontWeight: '600',
          fontFamily: 'system-ui,-apple-system,Segoe UI,Roboto,sans-serif'
        },
        optimized: false
      });
    } else {
      hoverLabelMarker.setPosition(center);
      hoverLabelMarker.setLabel({
        text: String(zip),
        color: '#111',
        fontSize: '12px',
        fontWeight: '600',
        fontFamily: 'system-ui,-apple-system,Segoe UI,Roboto,sans-serif'
      });
      hoverLabelMarker.setMap(map);
    }
  });
  map.data.addListener('mousemove', (e) => {
    const center = centerOfFeature(e.feature) || e.latLng;
    if (hoverLabelMarker && center) hoverLabelMarker.setPosition(center);
  });
  map.data.addListener('mouseout', (e) => {
    if (lastHighlighted !== e.feature) map.data.revertStyle(e.feature);
    if (hoverLabelMarker) hoverLabelMarker.setMap(null);
  });

  // ---- Interactive legend (requested order) ----
  const ORDER = ["Free Delivery", "$6", "$6 Prepay", "$10", "$10 Prepay", "$15", "$15 Prepay", "$20", "$20 Prepay"];
  const groupsByLabel = (() => {
    const m = new Map();
    ZIP_GROUPS.forEach(g => m.set(g.label, g));
    if (!m.has("Free Delivery")) m.set("Free Delivery", { label:"Free Delivery", color:getColor("Free Delivery"), prepay:false, fee:0 });
    return m;
  })();

  const legend = document.createElement('div');
  legend.style.background = '#fff';
  legend.style.margin = '10px';
  legend.style.padding = '10px';
  legend.style.borderRadius = '10px';
  legend.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
  legend.style.font = '13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';

  const title = document.createElement('div');
  title.style.fontWeight = '700';
  title.style.marginBottom = '6px';
  title.textContent = 'Service Areas';
  legend.appendChild(title);

  ORDER.forEach(label => {
    const g = groupsByLabel.get(label);
    if (!g) return;

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.setAttribute('data-label', g.label);
    btn.style.display = 'flex';
    btn.style.alignItems = 'center';
    btn.style.gap = '8px';
    btn.style.width = '100%';
    btn.style.margin = '4px 0';
    btn.style.padding = '6px 8px';
    btn.style.border = '1px solid rgba(0,0,0,.08)';
    btn.style.borderRadius = '8px';
    btn.style.background = '#fff';
    btn.style.cursor = 'pointer';
    btn.style.textAlign = 'left';

    const swatch = document.createElement('span');
    swatch.style.display = 'inline-block';
    swatch.style.width = '14px';
    swatch.style.height = '14px';
    swatch.style.borderRadius = '3px';
    swatch.style.background = g.color;
    swatch.style.border = '1px solid rgba(0,0,0,.12)';

    // Show "$X" text even when label is "$X Prepay"
    const baseLabelText = g.label.replace(' Prepay', '');
    const text = document.createElement('span');
    text.textContent = baseLabelText;

    btn.appendChild(swatch);
    btn.appendChild(text);

    if (g.prepay) {
      const pill = document.createElement('span');
      pill.textContent = 'Prepay';
      pill.style.marginLeft = '6px';
      pill.style.background = '#fde68a';
      pill.style.color = '#8b5e00';
      pill.style.border = '1px solid #f5d565';
      pill.style.borderRadius = '999px';
      pill.style.padding = '0 6px';
      pill.style.fontSize = '11px';
      pill.style.fontWeight = '700';
      btn.appendChild(pill);
    }

    // Click-to-spotlight behavior
    btn.addEventListener('click', () => {
      const clicked = btn.getAttribute('data-label');
      activeLegend = (activeLegend === clicked) ? null : clicked;

      // visual state
      legend.querySelectorAll('[data-label]').forEach(el => {
        const isActive = el.getAttribute('data-label') === activeLegend;
        el.style.outline = isActive ? '2px solid #111827' : 'none';
        el.style.background = isActive ? 'rgba(0,0,0,0.04)' : '#fff';
      });

      if (window.__refreshZoneStyles) window.__refreshZoneStyles();
      if (typeof clearHighlight === 'function') clearHighlight(map);
    });

    legend.appendChild(btn);
  });

  map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);

  // ---- Autocomplete (Philly + South NJ bias) ----
  const phillySJBounds = new google.maps.LatLngBounds(
    { lat: 39.35, lng: -75.85 },
    { lat: 40.40, lng: -74.20 }
  );
  const input = document.getElementById('search');
  const ac = new google.maps.places.Autocomplete(input, {
    fields: ['geometry','formatted_address','address_components','place_id'],
    bounds: phillySJBounds,
    strictBounds: false,
    types: ['address'],
    componentRestrictions: { country: ['us'] }
  });
  const geocoder = new google.maps.Geocoder();

  const clearEl = document.getElementById('clearBtn');
  if (clearEl) {
    clearEl.addEventListener('click', () => {
      input.value = '';
      input.focus();
      if (marker) { marker.setMap(null); marker = null; }
      clearHighlight(map);
      info.close();
      if (hoverLabelMarker) hoverLabelMarker.setMap(null);
      // also clear legend filter
      activeLegend = null;
      const nodeList = legend.querySelectorAll('[data-label]');
      nodeList.forEach(el => { el.style.outline = 'none'; el.style.background = '#fff'; });
      if (window.__refreshZoneStyles) window.__refreshZoneStyles();
    });
  }

  // Search handler — camera stays on the address
  ac.addListener('place_changed', async () => {
    const place = ac.getPlace();
    let location = place?.geometry?.location || null;
    const isStreetAddress = (place.address_components || []).some(c => c.types.includes('street_number'));

    if (!location || !isStreetAddress) {
      try {
        const q = input.value.trim();
        const { results } = await geocoder.geocode({
          address: q, bounds: phillySJBounds, componentRestrictions: { country: 'US' }
        });
        if (results && results[0]?.geometry?.location) location = results[0].geometry.location;
      } catch (_) {}
    }
    if (!location) return;

    if (!marker) marker = new google.maps.Marker({ map, position: location });
    else marker.setPosition(location);

    if (place?.geometry?.viewport) map.fitBounds(place.geometry.viewport);
    else { map.setCenter(location); map.setZoom(17); }

    const containing = findContainingFeature(map, location);
    if (containing) {
      highlightFeature(map, containing);
      const zip = getZipFromFeature(containing);
      const s = ZIP_STYLE.get(String(zip)) || {};
      info.setContent(popupHTML({
        zip,
        label: s.label || 'Free Delivery',
        prepay: !!s.prepay
      }));
      info.open({ map, position: location });
    } else {
      clearHighlight(map);
      info.setContent(popupHTML({
        zip: '—',
        label: 'Free Delivery',
        prepay: false
      }));
      info.open({ map, position: location });
    }
  });
}

// Expose callback globally
window.initMap = initMap;

/* Helpers */
function getZipFromFeature(feature){
  return feature.getProperty('ZCTA5CE20') || feature.getProperty('ZCTA5CE10') || feature.getProperty('GEOID');
}
function highlightFeature(map, feature){
  clearHighlight(map);
  lastHighlighted = feature;
  map.data.overrideStyle(feature, { fillOpacity: 0.6, strokeWeight: 4, zIndex: 1000 });
}
function clearHighlight(map){
  if (lastHighlighted){ map.data.revertStyle(lastHighlighted); lastHighlighted = null; }
}
function findContainingFeature(map, latLng){
  let found = null;
  map.data.forEach(f => { if (featureContainsLatLng(f, latLng)) found = f; });
  return found;
}
function featureContainsLatLng(feature, latLng){
  const geom = feature.getGeometry();
  let inside = false;
  const walk = (g) => {
    const t = g.getType();
    if (t === 'Polygon'){
      const paths = g.getArray().map(r => r.getArray());
      const poly = new google.maps.Polygon({ paths });
      if (google.maps.geometry.poly.containsLocation(latLng, poly)) inside = true;
    } else if (t === 'MultiPolygon' || t === 'GeometryCollection'){
      g.getArray().forEach(walk);
    }
  };
  walk(geom);
  return inside;
}
/* Bounds center as robust centroid */
function centerOfFeature(feature){
  const bounds = new google.maps.LatLngBounds();
  let has = false;
  const walk = (g) => {
    const t = g.getType();
    if (t === 'Polygon'){
      g.getArray().forEach(ring => ring.getArray().forEach(pt => { bounds.extend(pt); has = true; }));
    } else if (t === 'MultiPolygon' || t === 'GeometryCollection'){
      g.getArray().forEach(walk);
    } else if (t === 'Point'){
      bounds.extend(g.get()); has = true;
    }
  };
  walk(feature.getGeometry());
  return has ? bounds.getCenter() : null;
}
    </script>

    <!-- Loader: Maps + Places + Geometry -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDihHSv5KORtpnnMC7umGgXWBJm5NSduc8&callback=initMap&loading=async&libraries=places,geometry">
    </script>
  </head>

  <body>
    <!-- Search control (placed in TOP_LEFT by initMap) -->
    <div id="searchWrap">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.71.71l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
      </svg>
      <input id="search" type="text" placeholder="Search an address (Philly + South NJ)" />
      <button id="clearBtn" title="Clear">✕</button>
    </div>

    <div id="map"></div>
  </body>
</html>
