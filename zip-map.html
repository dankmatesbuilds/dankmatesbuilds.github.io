<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dankmates Delivery Zones</title>
    <style>
      :root{
        --bg:#ffffff; --text:#111827; --muted:#6b7280;
        --brand:#2563eb; --ring:rgba(37,99,235,.25);
        --shadow:0 8px 24px rgba(0,0,0,.12); --radius:14px;
      }
      html,body{height:100%;margin:0;}
      #map{height:100%;width:100%;}

      /* Search control (sits in TOP_LEFT via JS) */
      #searchWrap{
        display:flex; align-items:center; gap:8px;
        background:var(--bg); color:var(--text);
        border-radius:var(--radius); padding:10px 12px;
        box-shadow:var(--shadow); border:1px solid #e5e7eb;
        margin:10px;
      }
      #searchWrap .icon{width:18px;height:18px;fill:var(--muted);}
      #search{width:320px;max-width:62vw;border:none;outline:none;font-size:14px;color:var(--text);background:transparent;}
      #search::placeholder{color:#9ca3af;}
      #searchWrap:focus-within{box-shadow:var(--shadow),0 0 0 4px var(--ring);border-color:#d1d5db;}
      #clearBtn{appearance:none;border:none;background:#f3f4f6;color:#6b7280;width:26px;height:26px;border-radius:8px;cursor:pointer;line-height:26px;text-align:center;font-size:14px;}
      #clearBtn:hover{background:#e5e7eb;}

      /* Pretty InfoWindow content */
      .dm-popup{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;min-width:240px;max-width:320px;color:var(--text);}
      .dm-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:linear-gradient(135deg,#111827,#374151);color:#fff;border-radius:12px 12px 0 0;}
      .dm-fee{background:#fff;color:#111827;font-weight:700;padding:2px 8px;border-radius:999px;font-size:12px;}
      .dm-prepay{background:#fde68a;color:#92400e;font-weight:700;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #f59e0b;}
      .dm-body{padding:12px;background:#fff;border-radius:0 0 12px 12px;border:1px solid #e5e7eb;border-top:none;}
      .dm-row{display:flex;gap:8px;margin:6px 0;font-size:14px;}
      .dm-label{width:76px;color:var(--muted);}
      .dm-chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;font-size:12px;}
      .dm-dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
    </style>

    <script>
/** NEW GROUPS ‚Äî label is the fee; prepay groups show a ‚ÄúPrepay‚Äù tag */
const ZIP_GROUPS = [
  // colors picked to be distinct and harmonious
  { label:"$6",         fee:6,  prepay:false, color:"#2ca02c", zips:["19153","19131","19151","19140","19134","19129"] },
  { label:"$6 Prepay",  fee:6,  prepay:true,  color:"#8dd3c7", zips:["19032","19079","19023","19050"] },

  { label:"$10 Prepay", fee:10, prepay:true,  color:"#80b1d3", zips:["19082","19004","19074","19066","19036","19096","19018","19026","19113","19029"] },
  { label:"$15 Prepay", fee:15, prepay:true,  color:"#bebada", zips:["19072","19003","19083","19078","19076","19043","19070"] },

  { label:"$20 Prepay", fee:20, prepay:true,  color:"#fb8072",
    zips:[
      "19022","19094","19081","19064","19041","19010","19085","19428","19035","19027",
      /* 19012 removed here to resolve conflict (assigned to $15 below) */
      "19114","19115","19154","19116","19046","19038","19095","19444","19428","19020","19021","19007"
    ]
  },

  { label:"$10",        fee:10, prepay:false, color:"#fdb462", zips:["19127","19144","19141","19120","19124","19137"] },
  { label:"$15",        fee:15, prepay:false, color:"#b3de69", zips:["19128","19119","19138","19126","19135","19149","19012"] },
  { label:"$20",        fee:20, prepay:false, color:"#fccde5", zips:["19118","19150","19111","19136","19152"] }
];

/** Fast lookup: ZIP -> group meta */
const ZIP_STYLE = (() => {
  const m = new Map();
  ZIP_GROUPS.forEach(g => g.zips.forEach(z => m.set(String(z), { color: g.color, label: g.label, fee: g.fee, prepay: g.prepay })));
  return m;
})();

/* Popup template ‚Äî header shows fee label; chips for ZIP and ‚ÄúPrepay‚Äù when applicable */
function popupHTML({address, zip, label, fee, color, prepay}){
  return `
    <div class="dm-popup">
      <div class="dm-head">
        <div>${label}</div>
        <div style="display:flex; gap:6px;">
          ${prepay ? `<div class="dm-prepay">Prepay</div>` : ``}
          <div class="dm-fee" style="background:#111827;color:#fff;">${zip}</div>
        </div>
      </div>
      <div class="dm-body">
        ${address ? `<div class="dm-row"><div class="dm-label">Address</div><div>${address}</div></div>` : ''}
        <div class="dm-row"><div class="dm-label">Zone</div>
          <div class="dm-chip"><span class="dm-dot" style="background:${color}"></span>${label}${prepay ? " ¬∑ Prepay" : ""}</div>
        </div>
      </div>
    </div>
  `;
}

let lastHighlighted = null;
let marker = null;
let info = null;

/* Lightweight text label overlay (for hover ZIP text, not a popup) */
class TextLabel extends google.maps.OverlayView {
  constructor(opts) { super(); this.position = opts.position; this.text = opts.text; this.div = null; }
  onAdd(){
    this.div = document.createElement('div');
    this.div.style.position = 'absolute';
    this.div.style.transform = 'translate(-50%,-50%)';
    this.div.style.padding = '2px 6px';
    this.div.style.font = '600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
    this.div.style.color = '#111';
    this.div.style.background = 'rgba(255,255,255,0.9)';
    this.div.style.border = '1px solid #e5e7eb';
    this.div.style.borderRadius = '6px';
    this.div.style.boxShadow = '0 2px 6px rgba(0,0,0,.12)';
    this.div.style.pointerEvents = 'none';
    this.div.textContent = this.text;
    const panes = this.getPanes();
    panes.floatPane.appendChild(this.div);
  }
  draw(){
    const proj = this.getProjection();
    const p = proj.fromLatLngToDivPixel(this.position);
    if (!this.div) return;
    this.div.style.left = p.x + 'px';
    this.div.style.top  = p.y + 'px';
  }
  onRemove(){ if (this.div && this.div.parentNode) this.div.parentNode.removeChild(this.div); this.div = null; }
  setPosition(pos){ this.position = pos; this.draw(); }
  setText(t){ this.text = t; if (this.div) this.div.textContent = t; }
}

function initMap() {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 10,
    center: { lat: 39.9526, lng: -75.1652 }
  });

  map.setOptions({
    mapTypeControl: true,
    mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT }
  });
  map.controls[google.maps.ControlPosition.TOP_LEFT]
    .push(document.getElementById('searchWrap'));

  info = new google.maps.InfoWindow();
  let hoverLabel = null; // one text label reused for hover

  // Load polygons and style by fee; darker outlines for any $20 groups
  map.data.loadGeoJson('zip-map.json', null, () => {
  map.data.setStyle(feature => {
    const zip = feature.getProperty('ZCTA5CE20') || feature.getProperty('ZCTA5CE10') || feature.getProperty('GEOID');
    const s = ZIP_STYLE.get(String(zip));
    const fee = s?.fee ?? 0;

    const fillOpacity =
      fee >= 20 ? 0.45 :
      fee >= 15 ? 0.35 :
      fee >= 10 ? 0.30 :
      fee >=  6 ? 0.28 : 0.25;

    // üîß Uniform outline style for all zones
    return {
      fillColor: s ? s.color : "#999999",
      fillOpacity,
      strokeColor: s ? s.color : '#666666',
      strokeWeight: 1.5
    };
  });
});


  // Click ‚Üí pretty popup + strong highlight
  map.data.addListener('click', (e) => {
    const zip = getZipFromFeature(e.feature);
    const s = ZIP_STYLE.get(String(zip)) || {};
    highlightFeature(map, e.feature);

    info.setContent(popupHTML({
      address: null, zip, label: s.label || '$‚Äî', fee: s.fee || 0, color: s.color || '#999', prepay: !!s.prepay
    }));
    info.setPosition(e.latLng);
    info.open(map);
  });

  // Hover effects: thicken outline + centered ZIP text (no popup)
  map.data.addListener('mouseover', (e) => {
    const zip = getZipFromFeature(e.feature);
    map.data.overrideStyle(e.feature, { strokeWeight: 3, fillOpacity: 0.36 });

    const center = centerOfFeature(e.feature);
    if (!center) return;

    if (!hoverLabel) {
      hoverLabel = new TextLabel({ position: center, text: zip });
      hoverLabel.setMap(map);
    } else {
      hoverLabel.setText(zip);
      hoverLabel.setPosition(center);
      hoverLabel.setMap(map);
    }
  });
  map.data.addListener('mouseout', (e) => {
    if (lastHighlighted !== e.feature) map.data.revertStyle(e.feature);
    if (hoverLabel) hoverLabel.setMap(null);
  });

  // Legend ‚Äî shows label and Prepay
  const legend = document.createElement('div');
  legend.style.background = '#fff';
  legend.style.margin = '10px';
  legend.style.padding = '8px 10px';
  legend.style.borderRadius = '8px';
  legend.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
  legend.innerHTML = '<b>Service Areas</b><br/>' +
    ZIP_GROUPS.map(g => `
      <div style="display:flex;align-items:center;margin:4px 0;">
        <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${g.color};margin-right:8px;"></span>
        ${g.label}${g.prepay ? ' <span style="margin-left:6px;background:#fde68a;border:1px solid #f59e0b;color:#92400e;border-radius:999px;padding:0 6px;font-size:11px;">Prepay</span>' : ''}
      </div>`).join('');
  map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);

  // Autocomplete (Philly + South NJ bias)
  const phillySJBounds = new google.maps.LatLngBounds(
    { lat: 39.35, lng: -75.85 },
    { lat: 40.40, lng: -74.20 }
  );

  const input = document.getElementById('search');
  const ac = new google.maps.places.Autocomplete(input, {
    fields: ['geometry','formatted_address','address_components','place_id'],
    bounds: phillySJBounds,
    strictBounds: false,
    types: ['address'],
    componentRestrictions: { country: ['us'] }
  });
  const geocoder = new google.maps.Geocoder();

  const clearEl = document.getElementById('clearBtn');
  if (clearEl) {
    clearEl.addEventListener('click', () => {
      input.value = '';
      input.focus();
      if (marker) { marker.setMap(null); marker = null; }
      clearHighlight(map);
      info.close();
      if (hoverLabel) hoverLabel.setMap(null);
    });
  }

  // Search handler ‚Äî camera stays on address
  ac.addListener('place_changed', async () => {
    const place = ac.getPlace();
    let location = place?.geometry?.location || null;
    const isStreetAddress = (place.address_components || []).some(c => c.types.includes('street_number'));

    if (!location || !isStreetAddress) {
      try {
        const q = input.value.trim();
        const { results } = await geocoder.geocode({
          address: q, bounds: phillySJBounds, componentRestrictions: { country: 'US' }
        });
        if (results && results[0]?.geometry?.location) location = results[0].geometry.location;
      } catch (_) {}
    }
    if (!location) return;

    if (!marker) marker = new google.maps.Marker({ map, position: location });
    else marker.setPosition(location);

    if (place?.geometry?.viewport) map.fitBounds(place.geometry.viewport);
    else { map.setCenter(location); map.setZoom(17); }

    const containing = findContainingFeature(map, location);
    if (containing) {
      highlightFeature(map, containing);
      const zip = getZipFromFeature(containing);
      const s = ZIP_STYLE.get(String(zip)) || {};

      info.setContent(popupHTML({
        address: place.formatted_address || '‚Äî',
        zip, label: s.label || '$‚Äî', fee: s.fee || 0, color: s.color || '#999', prepay: !!s.prepay
      }));
      info.open({ map, position: location });
    } else {
      clearHighlight(map);
      info.setContent(`<div class="dm-popup"><div class="dm-head"><div>Result</div><div class="dm-fee">$‚Äî</div></div><div class="dm-body"><div class="dm-row"><div class="dm-label">Address</div><div>${place.formatted_address || '‚Äî'}</div></div><div class="dm-row"><div class="dm-label">Status</div><div>Not in a mapped ZIP.</div></div></div></div>`);
      info.open({ map, position: location });
    }
  });
}

// Expose callback globally so the loader can find it
window.initMap = initMap;

/* Helpers */
function getZipFromFeature(feature){
  return feature.getProperty('ZCTA5CE20') || feature.getProperty('ZCTA5CE10') || feature.getProperty('GEOID');
}
function highlightFeature(map, feature){
  clearHighlight(map);
  lastHighlighted = feature;
  map.data.overrideStyle(feature, { fillOpacity: 0.6, strokeWeight: 4, zIndex: 1000 });
}
function clearHighlight(map){
  if (lastHighlighted){ map.data.revertStyle(lastHighlighted); lastHighlighted = null; }
}
function findContainingFeature(map, latLng){
  let found = null;
  map.data.forEach(f => { if (featureContainsLatLng(f, latLng)) found = f; });
  return found;
}
function featureContainsLatLng(feature, latLng){
  const geom = feature.getGeometry();
  let inside = false;
  const walk = (g) => {
    const t = g.getType();
    if (t === 'Polygon'){
      const paths = g.getArray().map(r => r.getArray());
      const poly = new google.maps.Polygon({ paths });
      if (google.maps.geometry.poly.containsLocation(latLng, poly)) inside = true;
    } else if (t === 'MultiPolygon' || t === 'GeometryCollection'){
      g.getArray().forEach(walk);
    }
  };
  walk(geom);
  return inside;
}
function getFeatureBounds(feature){
  const bounds = new google.maps.LatLngBounds(); let has = false;
  const walk = (g) => {
    const t = g.getType();
    if (t === 'Polygon' || t === 'LineString'){
      g.getArray().forEach(path => {
        (path.getArray ? path.getArray() : [path]).forEach(pt => { bounds.extend(pt); has = true; });
      });
    } else if (t === 'MultiPolygon' || t === 'MultiLineString' || t === 'GeometryCollection'){
      g.getArray().forEach(walk);
    } else if (t === 'Point'){ bounds.extend(g.get()); has = true; }
  };
  walk(feature.getGeometry());
  return has ? bounds.getCenter() : null;
}
/* centerOfFeature: use bounds center as a robust centroid */
function centerOfFeature(feature){
  const b = getFeatureBounds(feature);
  return b || null;
}
    </script>

    <!-- Loader: Maps + Places + Geometry -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&loading=async&libraries=places,geometry">
    </script>
  </head>

  <body>
    <!-- Search control (placed in TOP_LEFT by initMap) -->
    <div id="searchWrap">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.71.71l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
      </svg>
      <input id="search" type="text" placeholder="Search an address (Philly + South NJ)" />
      <button id="clearBtn" title="Clear">‚úï</button>
    </div>

    <div id="map"></div>
  </body>
</html>
