<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dankmates Delivery Zones</title>
    <style>
      :root{
        --bg: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --brand: #2563eb;
        --ring: rgba(37, 99, 235, .25);
        --shadow: 0 8px 24px rgba(0,0,0,.12);
        --radius: 14px;
      }
      html, body { height:100%; margin:0; }
      #map { height:100%; width:100%; }

      /* ---- Search styling ---- */
      #searchWrap{
        position:absolute; z-index:5; top:16px; left:16px;
        display:flex; align-items:center; gap:8px;
        background:var(--bg); color:var(--text);
        border-radius: var(--radius);
        padding:10px 12px; box-shadow: var(--shadow);
        border:1px solid #e5e7eb;
      }
      #searchWrap .icon{
        width:18px; height:18px; fill:var(--muted);
      }
      #search{
        width:320px; max-width:62vw;
        border:none; outline:none; font-size:14px; color:var(--text);
        background:transparent;
      }
      #search::placeholder{ color:#9ca3af; }
      #searchWrap:focus-within{
        box-shadow: var(--shadow), 0 0 0 4px var(--ring);
        border-color:#d1d5db;
      }
      #clearBtn{
        appearance:none; border:none; background:#f3f4f6; color:#6b7280;
        width:26px; height:26px; border-radius:8px; cursor:pointer;
        line-height:26px; text-align:center; font-size:14px;
      }
      #clearBtn:hover{ background:#e5e7eb; }

      /* ---- Pretty popup (InfoWindow content) ---- */
      .dm-popup{
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        min-width: 240px; max-width: 320px;
        color: var(--text);
      }
      .dm-head{
        display:flex; justify-content:space-between; align-items:center;
        padding:10px 12px;
        background: linear-gradient(135deg, #111827, #374151);
        color:#fff; border-radius:12px 12px 0 0;
      }
      .dm-fee{
        background:#fff; color:#111827; font-weight:700;
        padding:2px 8px; border-radius:999px; font-size:12px;
      }
      .dm-body{
        padding:12px; background:#fff; border-radius:0 0 12px 12px;
        border:1px solid #e5e7eb; border-top:none;
      }
      .dm-row{ display:flex; gap:8px; margin:6px 0; font-size:14px; }
      .dm-label{ width:76px; color:var(--muted); }
      .dm-chip{
        display:inline-flex; align-items:center; gap:6px;
        padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb;
        background:#f9fafb; font-size:12px;
      }
      .dm-dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    </style>

    <script>
/** DELIVERY ZONES — with fee tiers from City Hall (0, 6, 10, 15, 20) */
const ZIP_GROUPS = [
  // — PHILADELPHIA (191xx) —
  { name: "Center City",            color: "#1f77b4", fee: 0,
    zips: ["19102","19103","19106","19107"] },

  { name: "University City",        color: "#17becf", fee: 0,
    zips: ["19104","19139"] },

  { name: "South Philly",           color: "#ff7f0e", fee: 6,
    zips: ["19145","19146","19147","19148"] },

  { name: "River Wards",            color: "#d62728", fee: 6,
    zips: ["19122","19123","19124","19125","19133","19134"] },

  { name: "West & SW Philly",       color: "#2ca02c", fee: 6,
    zips: ["19131","19143","19151"] },

  { name: "Airport / Navy Yard",    color: "#e377c2", fee: 10,
    zips: ["19112","19153"] },

  { name: "North Philly",           color: "#9467bd", fee: 10,
    zips: ["19121","19130","19132","19140","19141","19150"] },

  { name: "Northeast Core",         color: "#7f7f7f", fee: 10,
    zips: ["19124","19126","19137","19138"] },

  { name: "Northwest (Rox/CH/Manayunk)", color: "#8c564b", fee: 15,
    zips: ["19118","19119","19128","19129","19144"] },

  { name: "Far Northeast",          color: "#bcbd22", fee: 20,
    zips: ["19111","19114","19115","19116","19135","19136","19149","19152","19154"] },

  // — INNER PA SUBURBS (190xx) —
  { name: "Main Line",              color: "#2b8a3e", fee: 15,
    zips: ["19003","19004","19010","19041","19066","19072","19085","19096","19035"] },

  { name: "Montco NE Burbs",        color: "#228be6", fee: 10,
    zips: ["19012","19027","19038","19046"] },

  { name: "Lower Bucks",            color: "#ffa94d", fee: 20,
    zips: ["19007","19020","19021"] },

  { name: "Delco Inner Ring",       color: "#fa5252", fee: 10,
    zips: [
      "19022","19023","19026","19029","19032","19033","19036","19043","19050",
      "19064","19070","19074","19076","19078","19079","19081","19082","19083","19094"
    ] },

  // — PO/Business ZIPs (often no polygons) —
  { name: "Downtown PO/Business ZIPs", color: "#495057", fee: 0,
    zips: [
      "19019","19092","19093","19099","19101","19105","19108","19109","19110",
      "19155","19160","19161","19162","19170","19171","19172","19173","19175",
      "19176","19177","19178","19179","19181","19182","19183","19184","19185",
      "19187","19188","19190","19191","19192","19193","19194","19195","19196",
      "19197","19244","19255"
    ] }
];

/** Quick lookup: ZIP -> {color, name} */
const ZIP_STYLE = (() => {
  const m = new Map();
  ZIP_GROUPS.forEach(g => g.zips.forEach(z => m.set(String(z), { color: g.color, name: g.name })));
  return m;
})();

/* --- Pretty popup helper --- */
function popupHTML({address, zip, groupName, fee, color}){
  return `
    <div class="dm-popup">
      <div class="dm-head">
        <div>${address ? address : 'Delivery Zone'}</div>
        <div class="dm-fee">$${fee}</div>
      </div>
      <div class="dm-body">
        ${address ? `<div class="dm-row"><div class="dm-label">Address</div><div>${address}</div></div>` : ''}
        <div class="dm-row"><div class="dm-label">ZIP</div><div>${zip}</div></div>
        <div class="dm-row">
          <div class="dm-label">Zone</div>
          <div class="dm-chip"><span class="dm-dot" style="background:${color}"></span>${groupName}</div>
        </div>
      </div>
    </div>
  `;
}

let lastHighlighted = null;
let marker = null;
let info = null;

function initMap() {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 10,
    center: { lat: 39.9526, lng: -75.1652 } // City Hall-ish
  });

  info = new google.maps.InfoWindow();

  // Load polygons + style by group; darken opacity by fee
  map.data.loadGeoJson('zip-map.json', null, () => {
    map.data.setStyle(feature => {
      const zip = feature.getProperty('ZCTA5CE20')
                || feature.getProperty('ZCTA5CE10')
                || feature.getProperty('GEOID');
      const s = ZIP_STYLE.get(String(zip));
      const groupObj = ZIP_GROUPS.find(g => g.name === (s?.name));
      const fee = groupObj?.fee ?? 0;
      const opacity =
        fee >= 20 ? 0.45 :
        fee >= 15 ? 0.35 :
        fee >= 10 ? 0.30 :
        fee >=  6 ? 0.28 : 0.25;

      return {
        fillColor: s ? s.color : "#999999",
        fillOpacity: opacity,
        strokeColor: s ? s.color : "#666666",
        strokeWeight: 1
      };
    });
  });

  // Click → pretty popup with ZIP + group + fee
  map.data.addListener('click', (e) => {
    const zip = getZipFromFeature(e.feature);
    const s = ZIP_STYLE.get(String(zip));
    const groupName = s?.name || "Ungrouped";
    const fee = (ZIP_GROUPS.find(g => g.name === groupName)?.fee ?? 0);
    info.setContent(popupHTML({
      address: null, zip, groupName, fee, color: s?.color || '#999'
    }));
    info.setPosition(e.latLng);
    info.open(map);
  });

  // Legend (shows fees)
  const legend = document.createElement('div');
  legend.style.background = '#fff';
  legend.style.margin = '10px';
  legend.style.padding = '8px 10px';
  legend.style.borderRadius = '8px';
  legend.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
  legend.innerHTML = '<b>Service Areas</b><br/>' +
    ZIP_GROUPS.map(g => `
      <div style="display:flex;align-items:center;margin:4px 0;">
        <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${g.color};margin-right:8px;"></span>
        ${g.name} <span style="color:#555">&nbsp;($${g.fee})</span>
      </div>`).join('');
  map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend);

  // --- Search bias: Philly + South NJ counties ---
  const phillySJBounds = new google.maps.LatLngBounds(
    { lat: 39.35, lng: -75.85 }, // SW (below Salem/Chester)
    { lat: 40.40, lng: -74.20 }  // NE (above Bucks / toward AC)
  );

  const input = document.getElementById('search');
  const ac = new google.maps.places.Autocomplete(input, {
    fields: ['geometry','formatted_address','address_components','place_id'],
    bounds: phillySJBounds,
    strictBounds: false,
    types: ['address'], // address-only suggestions
    componentRestrictions: { country: ['us'] }
  });
  const geocoder = new google.maps.Geocoder();

  // Clear button (safe if button exists)
  const clearEl = document.getElementById('clearBtn');
  if (clearEl) {
    clearEl.addEventListener('click', () => {
      input.value = '';
      input.focus();
      if (marker) { marker.setMap(null); marker = null; }
      clearHighlight(map);
      info.close();
    });
  }

  // Search handler with viewport + geocode fallback
  ac.addListener('place_changed', async () => {
    const place = ac.getPlace();

    // If Places result is fuzzy, geocode raw text as fallback
    let location = place?.geometry?.location || null;
    const isStreetAddress = (place.address_components || [])
      .some(c => c.types.includes('street_number'));

    if (!location || !isStreetAddress) {
      try {
        const q = input.value.trim();
        const { results } = await geocoder.geocode({
          address: q, bounds: phillySJBounds, componentRestrictions: { country: 'US' }
        });
        if (results && results[0]?.geometry?.location) {
          location = results[0].geometry.location;
        }
      } catch (_) {}
    }
    if (!location) return;

    // Drop/move marker
    if (!marker) marker = new google.maps.Marker({ map, position: location });
    else marker.setPosition(location);

    // Use viewport if provided; otherwise zoom to point
    if (place?.geometry?.viewport) map.fitBounds(place.geometry.viewport);
    else { map.setCenter(location); map.setZoom(17); }

    // Which ZIP polygon contains the point?
    const containing = findContainingFeature(map, location);
    if (containing) {
      highlightFeature(map, containing);
      const zip = getZipFromFeature(containing);
      const s = ZIP_STYLE.get(String(zip));
      const groupName = s?.name || 'Ungrouped';
      const fee = (ZIP_GROUPS.find(g => g.name === groupName)?.fee ?? 0);

      // Fit bounds to ZIP but keep the address point in frame
      const b = getFeatureBounds(containing);
      if (b) { b.extend(location); map.fitBounds(b, { top: 80, left: 20, bottom: 20, right: 20 }); }

      info.setContent(popupHTML({
        address: place.formatted_address || '—',
        zip, groupName, fee, color: s?.color || '#999'
      }));
      info.open({ map, position: location });
    } else {
      clearHighlight(map);
      info.setContent(`<div class="dm-popup"><div class="dm-head"><div>Result</div><div class="dm-fee">$—</div></div><div class="dm-body"><div class="dm-row"><div class="dm-label">Address</div><div>${place.formatted_address || '—'}</div></div><div class="dm-row"><div class="dm-label">Status</div><div>Not in a mapped ZIP.</div></div></div></div>`);
      info.open({ map, position: location });
    }
  });
} // <-- closes initMap()

/* Helpers */
function getZipFromFeature(feature) {
  return feature.getProperty('ZCTA5CE20')
      || feature.getProperty('ZCTA5CE10')
      || feature.getProperty('GEOID');
}
function highlightFeature(map, feature) {
  clearHighlight(map);
  lastHighlighted = feature;
  map.data.overrideStyle(feature, { fillOpacity: 0.6, strokeWeight: 2 });
}
function clearHighlight(map) {
  if (lastHighlighted) { map.data.revertStyle(lastHighlighted); lastHighlighted = null; }
}
function findContainingFeature(map, latLng) {
  let found = null;
  map.data.forEach(f => { if (featureContainsLatLng(f, latLng)) found = f; });
  return found;
}
function featureContainsLatLng(feature, latLng) {
  const geom = feature.getGeometry();
  let inside = false;
  const walk = (g) => {
    const t = g.getType();
    if (t === 'Polygon') {
      const paths = g.getArray().map(r => r.getArray());
      const poly = new google.maps.Polygon({ paths });
      if (google.maps.geometry.poly.containsLocation(latLng, poly)) inside = true;
    } else if (t === 'MultiPolygon') {
      g.getArray().forEach(walk);
    } else if (t === 'GeometryCollection') {
      g.getArray().forEach(walk);
    }
  };
  walk(geom);
  return inside;
}
function getFeatureBounds(feature) {
  const bounds = new google.maps.LatLngBounds(); let has = false;
  const walk = (g) => {
    const t = g.getType();
    if (t === 'Polygon' || t === 'LineString') {
      g.getArray().forEach(path => {
        (path.getArray ? path.getArray() : [path]).forEach(pt => { bounds.extend(pt); has = true; });
      });
    } else if (t === 'MultiPolygon' || t === 'MultiLineString' || t === 'GeometryCollection') {
      g.getArray().forEach(walk);
    } else if (t === 'Point') { bounds.extend(g.get()); has = true; }
  };
  walk(feature.getGeometry());
  return has ? bounds : null;
}
    </script>

    <!-- Modern loader: Maps + Places + Geometry -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDihHSv5KORtpnnMC7umGgXWBJm5NSduc8&callback=initMap&loading=async&libraries=places,geometry">
    </script>
  </head>

  <body>
    <!-- Styled search with clear button -->
    <div id="searchWrap">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.71.71l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
      </svg>
      <input id="search" type="text" placeholder="Search an address (Philly + South NJ)"/>
      <button id="clearBtn" title="Clear">✕</button>
    </div>

    <div id="map"></div>
  </body>
</html>
